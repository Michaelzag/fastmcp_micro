---
order: 1
---

# Gmail Retrieval Service (FastMCP)

_Proposed development order: 1_

# Overview

The Gmail Retrieval Service is a FastMCP component responsible for retrieving emails from Gmail accounts.

## Features

*   Connects to Gmail accounts using OAuth 2.0
*   Retrieves emails from the inbox, sent, and trash folders
*   Supports filtering by label, subject, and sender
*   Handles pagination for large email datasets

## Technical Requirements

*   Python 3.13+
*   `google-api-python-client`
*   `google-auth`
*   `google-auth-oauthlib`
*   All dependencies managed by `uv` and listed in `pyproject.toml`

## Setup

1.  Install the required libraries using pip:

    ```bash
pip install google-api-python-client google-auth google-auth-oauthlib
```

2.  Create a new OAuth 2.0 client ID in the Google Cloud Console:

    *   Go to the [Google Cloud Console](https://console.cloud.google.com/).
    *   Select your project.
    *   Click on "Navigation menu" (three horizontal lines in the top left corner).
    *   Click on "APIs & Services" > "Dashboard".
    *   Click on "Enable APIs and Services".
    *   Search for "Gmail API".
    *   Click on "Gmail API".
    *   Click on "Create credentials" > "OAuth client ID".
    *   Select "Other".
    *   Enter a name for your client ID.
    *   Click on "Create".
    *   Copy the client ID and client secret.

3.  Create a new file named `credentials.json` with the following content:

    ```json
{
  "installed": {
    "client_id": "YOUR_CLIENT_ID",
    "project_id": "YOUR_PROJECT_ID",
    "auth_uri": "https://accounts.google.com/o/oauth2/auth",
    "token_uri": "https://oauth2.googleapis.com/token",
    "auth_provider_x509_cert_url": "https://www.googleapis.com/oauth2/v1/certs",
    "client_secret": "YOUR_CLIENT_SECRET",
    "redirect_uris": ["urn:ietf:wg:oauth:2.0:oob", "http://localhost"]
  }
}
```

4.  Replace `YOUR_CLIENT_ID` and `YOUR_CLIENT_SECRET` with the values from the Google Cloud Console.

## Usage

1.  Run the following command to authenticate:

    ```bash
python authenticate.py
```

2.  Follow the prompts to authenticate with your Gmail account.

3.  Run the following command to retrieve emails:

    ```bash
python retrieve_emails.py
```

4.  The retrieved emails will be saved in the `emails` directory.

## API Documentation

### Gmail Retrieval Service

#### `get_emails`

*   Retrieves emails from the inbox, sent, and trash folders.
*   Supports filtering by label, subject, and sender.
*   Handles pagination for large email datasets.

#### `get_email`

*   Retrieves a single email by ID.

#### `search_emails`

*   Searches for emails using the Gmail search query syntax.

## Step-by-Step Implementation Plan

#### 1. Project Setup
- Initialize the project using `uv init gmail-retrieval-service` (Python 3.13+).
- Add dependencies: `uv add fastmcp pydantic google-api-python-client google-auth google-auth-oauthlib httpx logfire`.
- Use `main.py` as entry point, create `schemas.py` for Pydantic models, and `gmail_client.py` for Gmail logic.
- Store config and secrets (OAuth tokens) in `.env` or environment variables.

#### 2. Schema and Contract Definition
- Define `Email` and related schemas in `schemas.py` using Pydantic.
- Document expected input/output in the README and OpenAPI doc.

#### 3. Gmail API Integration
- Authenticate using OAuth2 (`google-auth`/`google-auth-oauthlib`).
- Use `google-api-python-client` for Gmail API access.
- Implement async email fetching with `httpx` if batching is needed.
- Filter messages by sender domain (e.g., `@amazon.com`).
- Handle pagination, errors, and API rate limits.

#### 4. MCP Interface Implementation
- Register `fetch_emails` as a FastMCP tool (input: filter params, output: list of `Email`).
- Register `get_email` as a FastMCP resource (input: email ID, output: `Email`).
- Expose both as REST endpoints via FastAPI (auto-generated by FastMCP).

#### 5. Configuration & Environment
- Use `dotenv` or FastMCP config loader to read `.env`.
- Document required environment variables: `GOOGLE_CLIENT_ID`, `GOOGLE_CLIENT_SECRET`, `GMAIL_REFRESH_TOKEN`, etc.
- Provide a sample `.env.example` file.

#### 6. Testing
- Unit tests for Gmail client logic (mock Gmail API).
- Integration tests for FastMCP endpoints (`fetch_emails`, `get_email`).
- Contract tests to ensure output matches Pydantic schemas.
- Edge case tests: empty inbox, malformed emails, API errors.
- Use `pytest` and `pytest-cov` for coverage.

#### 7. Observability & Logging
- Log all fetch attempts, errors, and API usage with `logfire`.
- Add metrics for fetch latency, error rate, and API quota usage.
- Provide log configuration in `pyproject.toml` or `.env`.

#### 8. Deployment
- Containerize with a `Dockerfile`.
- Expose port (default 8000) for FastAPI server.
- Document healthcheck endpoint (e.g., `/healthz`).
- Provide example `docker-compose.yml` for local dev.

#### 9. Security & Compliance
- Never log full email content or secrets.
- Validate all inputs with Pydantic.
- Store secrets in env, not in code or logs.
- Document data retention policy for email data.

#### 10. Maintenance & Future Work
- Document how to rotate OAuth tokens.
- Instructions for updating Gmail API scopes or permissions.
- Plan for adapting to Gmail API changes.
- Add monitoring hooks for production deployment.

### Example `.env.example`
```
GOOGLE_CLIENT_ID=...
GOOGLE_CLIENT_SECRET=...
GMAIL_REFRESH_TOKEN=...
LOG_LEVEL=INFO
```

### Example API Calls

#### Fetch Emails
`POST /tools/fetch_emails`
```json
{
  "from": "order-update@amazon.com",
  "since": "2024-01-01"
}
```

#### Get Email
`GET /resources/get_email/{email_id}`

### Troubleshooting Checklist
- [ ] Are all required env vars set? (`GOOGLE_CLIENT_ID`, `GOOGLE_CLIENT_SECRET`, `GMAIL_REFRESH_TOKEN`)
- [ ] Is Gmail API enabled for the Google Cloud project?
- [ ] Are FastMCP endpoints up and documented in OpenAPI?
- [ ] Are logs and metrics being generated?
- [ ] Do all contract tests pass?

## Contributing

Contributions are welcome! Please submit a pull request with your changes.

## License

This project is licensed under the MIT License.
