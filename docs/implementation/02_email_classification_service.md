---
order: 2
---

# Email Classification Service (FastMCP)

_Proposed development order: 2_

Email Classification Service (FastMCP)
=====================================

Overview
--------

The Email Classification Service is a FastMCP module that classifies incoming emails based on their content and sender information. The service uses machine learning algorithms to categorize emails into predefined categories, such as spam, phishing, or legitimate emails.

### Features

*   Email classification using machine learning algorithms
*   Support for multiple classification categories
*   Integration with FastMCP's email processing pipeline

### Technical Requirements

*   Python 3.13+
*   `scikit-learn`
*   `openai`
*   `fastmcp`, `pydantic`, `logfire`
*   All dependencies managed by `uv` and listed in `pyproject.toml`

### Configuration

The Email Classification Service can be configured using the following environment variables:

*   `FASTMCP_EMAIL_CLASSIFICATION_MODEL`: The path to the trained machine learning model
*   `FASTMCP_EMAIL_CLASSIFICATION_CATEGORIES`: A comma-separated list of classification categories

### API Endpoints

The Email Classification Service provides the following API endpoints:

*   `POST /classify`: Classify an incoming email
*   `GET /categories`: Retrieve a list of supported classification categories

### Example Use Cases

*   Classifying incoming emails in a FastMCP-based email processing pipeline
*   Integrating with other FastMCP modules for advanced email processing

### Development Roadmap

*   Implement email classification using machine learning algorithms
*   Integrate with FastMCP's email processing pipeline
*   Develop API endpoints for classification and category retrieval

### Step-by-Step Implementation Plan

#### 1. Project Setup
- Initialize the project using `uv init email-classification-service` (Python 3.13+).
- Add dependencies: `uv add fastmcp pydantic scikit-learn openai logfire`.
- Structure: use `main.py` as entry point, create `schemas.py` for Pydantic models, and `classifier.py` for logic.
- Store config and secrets (e.g., OpenAI API key) in `.env` or environment variables.

#### 2. Schema and Contract Definition
- Define `Email` and `ClassificationResult` schemas in `schemas.py` using Pydantic.
- Document expected input/output in the README and OpenAPI doc.

#### 3. Classifier Logic
- Implement a rule-based classifier (simple keyword/category mapping).
- Integrate ML classifier using scikit-learn (e.g., logistic regression, SVM) with a pre-trained model.
- Integrate LLM classifier using OpenAI API for fallback or advanced cases.
- Store model files in a dedicated `models/` directory, load at startup.
- Add a factory or strategy pattern to select the classifier backend.

#### 4. MCP Interface Implementation
- Register `classify_email` as a FastMCP tool (input: `Email`, output: `ClassificationResult`).
- Register `get_classification` as a FastMCP resource (input: email ID, output: classification result).
- Expose both as REST endpoints via FastAPI (auto-generated by FastMCP).

#### 5. Configuration & Environment
- Use `dotenv` or FastMCP config loader to read `.env`.
- Document required environment variables: `OPENAI_API_KEY`, `MODEL_PATH`, etc.
- Provide a sample `.env.example` file.

#### 6. Testing
- Unit tests for each classifier backend (rule, ML, LLM) using mocks and sample data.
- Integration tests for the FastMCP endpoints (`classify_email`, `get_classification`).
- Contract tests to ensure output matches Pydantic schemas.
- Add test cases for edge cases: empty email, ambiguous content, invalid input.
- Use `pytest` and `pytest-cov` for coverage.

#### 7. Observability & Logging
- Log all classification attempts, errors, and backend selection using `logfire`.
- Add metrics for classification latency, error rate, and backend usage.
- Provide log configuration in `pyproject.toml` or `.env`.

#### 8. Deployment
- Containerize with a `Dockerfile` (multi-stage if needed for model files).
- Expose port (default 8000) for FastAPI server.
- Document healthcheck endpoint (e.g., `/healthz`).
- Provide example `docker-compose.yml` for local development.

#### 9. Security & Compliance
- Never log full email content or secrets.
- Validate all inputs with Pydantic.
- Store secrets in env, not in code or logs.
- Document data retention policy for email and classification data.

#### 10. Maintenance & Future Work
- Document how to retrain or update the ML model.
- Provide instructions for adding new categories or classifier backends.
- Plan for model versioning and migration.
- Add monitoring hooks for production deployment.

### Example `.env.example`
```
OPENAI_API_KEY=sk-...
MODEL_PATH=models/classifier.pkl
LOG_LEVEL=INFO
```

### Example API Calls

#### Classify Email
`POST /tools/classify_email`
```json
{
  "subject": "Your Amazon Order Confirmation",
  "body": "Thank you for your purchase...",
  "from": "order-update@amazon.com",
  "to": "user@example.com"
}
```

#### Get Classification
`GET /resources/get_classification/{email_id}`

### Troubleshooting Checklist
- [ ] Are all required env vars set? (`OPENAI_API_KEY`, `MODEL_PATH`)
- [ ] Is the ML model file present and readable?
- [ ] Are FastMCP endpoints up and documented in OpenAPI?
- [ ] Are logs and metrics being generated?
- [ ] Do all contract tests pass?

### Testing

The Email Classification Service can be tested using the following command:

```bash
pytest tests/test_email_classification_service.py
```

### Deployment

The Email Classification Service can be deployed using the following command:

```bash
docker-compose up -d email-classification-service
```

### Troubleshooting

*   Check the service logs for errors
*   Verify that the machine learning model is properly trained and configured

### Future Work

*   Improve the accuracy of the machine learning model
*   Add support for additional classification categories
*   Integrate with other FastMCP modules for advanced email processing
